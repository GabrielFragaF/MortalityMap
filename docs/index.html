<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sea-turtle mortality map</title>
  <title>Sea-turtle mortality map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre GL JS -->
  <link rel="stylesheet"
        href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #panel {
      position:absolute; top:10px; left:10px; z-index:2;
      background:#fff; padding:6px 10px; border-radius:4px;
      font-family:sans-serif; font-size:14px;
      box-shadow:0 1px 4px rgba(0,0,0,.3); max-height:90%; overflow:auto;
    }
    #layerSel{ width:200px; margin-bottom:8px }
    details { margin-bottom:6px; }
    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 4px;
    }
    details select { width:100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <label>Resolution (hex-size):</label>
    <select id="resolution">
      <option value="r3">r3 (coarse)</option>
      <option value="r4">r4</option>
      <option value="r5">r5</option>
      <option value="r6">r6 (fine)</option>
    </select>

    <label>Species</label>
    <select id="speciesFilter" multiple size="6">
      <option value="all" selected>All</option>
      <option value="Caretta caretta">Caretta caretta</option>
      <option value="Chelonia mydas">Chelonia mydas</option>
      <option value="Dermochelys coriacea">Dermochelys coriacea</option>
      <option value="Eretmochelys imbricata">Eretmochelys imbricata</option>
      <option value="Lepidochelys olivacea">Lepidochelys olivacea</option>
    </select>
  </details>

  <!-- Development stage -->
  <details>
    <summary>Stage</summary>
    <select id="stageFilter" multiple size="4">
      <option value="Adulto">Adulto</option>
      <option value="Filhote">Filhote</option>
      <option value="Indeterminado">Indeterminado</option>
      <option value="Juvenil">Juvenil</option>
    </select>
  </details>

  <!-- Sex -->
  <details>
    <summary>Sex</summary>
    <select id="sexFilter" multiple size="3">
      <option value="Fêmea">Fêmea</option>
      <option value="Macho">Macho</option>
      <option value="Indefinido">Indefinido</option>
    </select>
  </details>

  <!-- Fishing -->
  <details>
    <summary>Fishing</summary>
    <select id="FishingFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Marine debris -->
  <details>
    <summary>Marine Debris</summary>
    <select id="Marine_DebrisFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Aggression -->
  <details>
    <summary>Agression</summary>
    <select id="AgressionFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Boat collision -->
  <details>
    <summary>Boat Collision</summary>
    <select id="Boat_collisionFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Dredging -->
  <details>
    <summary>Dredging</summary>
    <select id="DredgingFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Oil -->
  <details>
    <summary>Oil</summary>
    <select id="OilFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Petrol -->
  <details>
    <summary>Petrol</summary>
    <select id="PetrolFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Decomposition -->
  <details>
    <summary>Decomposition</summary>
    <select id="decomposition_codeFilter" multiple size="5">
      <option value="1.0">1.0</option>
      <option value="2.0">2.0</option>
      <option value="3.0">3.0</option>
      <option value="4.0">4.0</option>
      <option value="5.0">5.0</option>
    </select>
  </details>

  <!-- Season -->
  <details>
    <summary>Season</summary>
    <select id="seasonFilter" multiple size="4">
      <option value="Spring">Spring</option>
      <option value="Summer">Summer</option>
      <option value="Autumn">Autumn</option>
      <option value="Winter">Winter</option>
    </select>
  </details>

  <!-- Year -->
  <details>
    <summary>Year</summary>
    <select id="yearFilter" multiple size="6">
      <option value="2015.0">2015</option>
      <option value="2016.0">2016</option>
      <option value="2017.0">2017</option>
      <option value="2018.0">2018</option>
      <option value="2019.0">2019</option>
      <option value="2020.0">2020</option>
      <option value="2021.0">2021</option>
      <option value="2022.0">2022</option>
      <option value="2023.0">2023</option>
      <option value="2024.0">2024</option>
    </select>
  </details>

  <!-- Month -->
  <details>
    <summary>Month</summary>
    <select id="monthFilter" multiple size="6">
      <option value="1.0">January</option>
      <option value="2.0">February</option>
      <option value="3.0">March</option>
      <option value="4.0">April</option>
      <option value="5.0">May</option>
      <option value="6.0">June</option>
      <option value="7.0">July</option>
      <option value="8.0">August</option>
      <option value="9.0">September</option>
      <option value="10.0">October</option>
      <option value="11.0">November</option>
      <option value="12.0">December</option>
    </select>
  </div>

<div id="map"></div>

  <script>
    // 1) initialize map
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: {
            type: 'raster',
            tiles: [
              'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
              'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            tileSize: 256
          }
        },
        layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
      },
      center: [-45, -24],
      zoom: 5
    });

    // 2) color ramps
    const ramps = {
      all: ['#edf8fb','#b2e2e2','#66c2a4','#238b45','#00441b'],
      'Caretta caretta': ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'],
      'Chelonia mydas':   ['#f7fcf5','#c7e9c0','#74c476','#238b45','#00441b'],
      'Dermochelys coriacea': ['#f7fbff','#c6dbef','#6baed6','#2171b5','#08306b'],
      'Eretmochelys imbricata':['#fff7fb','#ece2f0','#a6bddb','#8771a8','#4d004b'],
      'Lepidochelys olivacea':['#fff7ec','#fee8c8','#fdbb84','#e34a33','#b30000']
    };

    // 3) build filter expression
    function buildFilter() {
      const f = ['all'];
      const props = [
        'species','development_stage','sex','Fishing','Marine_Debris',
        'Agression','Boat_collision','Dredging','Oil','Petrol',
        'decomposition_code','season','year','month'
      ];
      props.forEach(prop => {
        const sel = document.getElementById(prop+'Filter');
        const vals = Array.from(sel.selectedOptions).map(o=>o.value);
        if(vals.length && !vals.includes('all')) {
          f.push(['in',['get',prop],['literal',vals]]);
        }
      });
      return f;
    }

    // 4) refresh legend
    function updateLegend(ramp, values){
      const L = document.getElementById('legend');
      L.innerHTML = '';
      const min = Math.min(...values),
            max = Math.max(...values);
      ramp.forEach((c,i)=>{
        const sw = document.createElement('span');
        sw.className='swatch'; sw.style.background = c;
        L.appendChild(sw);
        const v = (min + (i+0.5)/ramp.length*(max-min)).toFixed(1);
        L.appendChild(document.createTextNode(v+' '));
      });
    }

    // 5) load a new layer
    function loadLayer(){
      const res = document.getElementById('resolution').value;
      const spSel = Array.from(
        document.getElementById('speciesFilter').selectedOptions
      ).map(o=>o.value).filter(v=>v!=='all');
      const species = spSel.length ? spSel[0] : 'all';
      const ramp = ramps[species] || ramps.all;
      const file = `hexgrid_${res}_${species}.geojson`;

      // remove old
      if(map.getSource('mort')){
        map.removeLayer('mort-fill');
        map.removeSource('mort');
      }
      // add new
      map.addSource('mort',{ type:'geojson', data: file });
      map.addLayer({
        id: 'mort-fill', type: 'fill', source: 'mort',
        paint: {
          'fill-color': [
            'interpolate',['linear'],['get','sum_val'],
            0, ramp[0], 10, ramp[1], 50, ramp[2], 200, ramp[3]
          ],
          'fill-opacity': 0.6
        }
      });
      map.setFilter('mort-fill', buildFilter());

      // load data to build legend
      fetch(file)
        .then(r=>r.json())
        .then(j=>{
          const vals = j.features.map(f=>f.properties.sum_val);
          updateLegend(ramp, vals);
        });
    }

    // 6) popup on hover
    const popup = new maplibregl.Popup({ closeButton:false, closeOnClick:false });
    map.on('mousemove','mort-fill', e=>{
      const p = e.lngLat, pr = e.features[0].properties;
      popup.setLngLat(p)
        .setHTML(`<b>sum_val:</b> ${pr.sum_val}<br><b>mortality:</b> ${pr.mortality}`)
        .addTo(map);
    });
    map.on('mouseleave','mort-fill', ()=>popup.remove());

    // 7) wire controls
    document.getElementById('resolution').onchange = loadLayer;
    document.querySelectorAll('#panel select').forEach(s=>{
      s.onchange = ()=> map.getSource('mort') && map.setFilter('mort-fill',buildFilter());
    });

    // 8) initial load on map ready
    map.on('load', ()=> loadLayer());
  </script>
</body>
</html>
