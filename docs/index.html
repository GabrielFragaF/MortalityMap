<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sea-turtle mortality map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MapLibre GL JS -->
  <link rel="stylesheet"
        href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>

  <style>
    html, body { margin:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #panel {
      position:absolute; top:10px; left:10px; z-index:2;
      background:#fff; padding:6px 10px; border-radius:4px;
      font-family:sans-serif; font-size:14px;
      box-shadow:0 1px 4px rgba(0,0,0,.3); max-height:90%; overflow:auto;
    }
    #layerSel{ width:200px; margin-bottom:8px }
    details { margin-bottom:6px; }
    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 4px;
    }
    details select { width:100%; }
  </style>
</head>
<body>

<div id="panel">
  <!-- 1) Layer selector -->
  <select id="layerSel">
    <optgroup label="H3 res 3">
      <option value="hexgrid_r3_weight.geojson">r3 weight</option>
      <option value="hexgrid_r3_new_weight.geojson">r3 new_weight</option>
      <option value="hexgrid_r3_new_mortality_est_bf_mean.geojson">r3 bf_mean</option>
      <option value="hexgrid_r3_new_mortality_est_bf_low.geojson">r3 bf_low</option>
      <option value="hexgrid_r3_new_mortality_est_bf_high.geojson">r3 bf_high</option>
    </optgroup>
    <optgroup label="H3 res 4">
      <option value="hexgrid_r4_weight.geojson">r4 weight</option>
      <option value="hexgrid_r4_new_weight.geojson">r4 new_weight</option>
      <option value="hexgrid_r4_new_mortality_est_bf_mean.geojson">r4 bf_mean</option>
      <option value="hexgrid_r4_new_mortality_est_bf_low.geojson">r4 bf_low</option>
      <option value="hexgrid_r4_new_mortality_est_bf_high.geojson">r4 bf_high</option>
    </optgroup>
    <!-- r5 and r6 omitted from tracking -->
  </select>
  <button id="loadBtn">Load layer</button>

  <!-- 2) Collapsible filters -->
  <!-- Species -->
  <details open>
    <summary>Species</summary>
    <select id="speciesFilter" multiple size="4">
      <option value="Caretta caretta">Caretta caretta</option>
      <option value="Chelonia mydas">Chelonia mydas</option>
      <option value="Dermochelys coriacea">Dermochelys coriacea</option>
      <option value="Eretmochelys imbricata">Eretmochelys imbricata</option>
      <option value="Lepidochelys olivacea">Lepidochelys olivacea</option>
    </select>
  </details>

  <!-- Development stage -->
  <details>
    <summary>Stage</summary>
    <select id="stageFilter" multiple size="4">
      <option value="Adulto">Adulto</option>
      <option value="Filhote">Filhote</option>
      <option value="Indeterminado">Indeterminado</option>
      <option value="Juvenil">Juvenil</option>
    </select>
  </details>

  <!-- Sex -->
  <details>
    <summary>Sex</summary>
    <select id="sexFilter" multiple size="3">
      <option value="Fêmea">Fêmea</option>
      <option value="Macho">Macho</option>
      <option value="Indefinido">Indefinido</option>
    </select>
  </details>

  <!-- Fishing -->
  <details>
    <summary>Fishing</summary>
    <select id="FishingFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Marine debris -->
  <details>
    <summary>Marine Debris</summary>
    <select id="Marine_DebrisFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Aggression -->
  <details>
    <summary>Agression</summary>
    <select id="AgressionFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Boat collision -->
  <details>
    <summary>Boat Collision</summary>
    <select id="Boat_collisionFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Dredging -->
  <details>
    <summary>Dredging</summary>
    <select id="DredgingFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Oil -->
  <details>
    <summary>Oil</summary>
    <select id="OilFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Petrol -->
  <details>
    <summary>Petrol</summary>
    <select id="PetrolFilter" multiple size="2">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <!-- Decomposition -->
  <details>
    <summary>Decomposition</summary>
    <select id="decomposition_codeFilter" multiple size="5">
      <option value="1.0">1.0</option>
      <option value="2.0">2.0</option>
      <option value="3.0">3.0</option>
      <option value="4.0">4.0</option>
      <option value="5.0">5.0</option>
    </select>
  </details>

  <!-- Season -->
  <details>
    <summary>Season</summary>
    <select id="seasonFilter" multiple size="4">
      <option value="Spring">Spring</option>
      <option value="Summer">Summer</option>
      <option value="Autumn">Autumn</option>
      <option value="Winter">Winter</option>
    </select>
  </details>

  <!-- Year -->
  <details>
    <summary>Year</summary>
    <select id="yearFilter" multiple size="6">
      <option value="2015.0">2015</option>
      <option value="2016.0">2016</option>
      <option value="2017.0">2017</option>
      <option value="2018.0">2018</option>
      <option value="2019.0">2019</option>
      <option value="2020.0">2020</option>
      <option value="2021.0">2021</option>
      <option value="2022.0">2022</option>
      <option value="2023.0">2023</option>
      <option value="2024.0">2024</option>
    </select>
  </details>

  <!-- Month -->
  <details>
    <summary>Month</summary>
    <select id="monthFilter" multiple size="6">
      <option value="1.0">January</option>
      <option value="2.0">February</option>
      <option value="3.0">March</option>
      <option value="4.0">April</option>
      <option value="5.0">May</option>
      <option value="6.0">June</option>
      <option value="7.0">July</option>
      <option value="8.0">August</option>
      <option value="9.0">September</option>
      <option value="10.0">October</option>
      <option value="11.0">November</option>
      <option value="12.0">December</option>
    </select>
  </details>

</div>

<div id="map"></div>

<script>
const BASEMAP_ID = "osm-tiles";
const SOURCE_ID = "mortality";
const LAYER_ID  = "mortality-fill";

// 1. init map
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      [BASEMAP_ID]: {
        type: 'raster',
        tiles: [
          'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
        ],
        tileSize: 256,
        attribution:
          "© <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a>"
      }
    },
    layers: [{
      id: BASEMAP_ID,
      type: 'raster',
      source: BASEMAP_ID,
      minzoom: 0, maxzoom: 22
    }]
  },
  center: [-45, -24],
  zoom: 5
});

// 2. build a reusable filter function
function buildFilter() {
  const filter = ['all'];
  function add(prop, id){
    const sel = document.getElementById(id);
    const vals = Array.from(sel.selectedOptions).map(o=>o.value);
    if(vals.length) filter.push(['in',['get',prop], ['literal',vals]]);
  }
  add('species', 'speciesFilter');
  add('development_stage','stageFilter');
  add('sex','sexFilter');
  add('Fishing','FishingFilter');
  add('Marine_Debris','Marine_DebrisFilter');
  add('Agression','AgressionFilter');
  add('Boat_collision','Boat_collisionFilter');
  add('Dredging','DredgingFilter');
  add('Oil','OilFilter');
  add('Petrol','PetrolFilter');
  add('decomposition_code','decomposition_codeFilter');
  add('season','seasonFilter');
  add('year','yearFilter');
  add('month','monthFilter');
  return filter;
}

// 3. apply filter to the fill layer
function updateFilter(){
  if(!map.getLayer(LAYER_ID)) return;
  map.setFilter(LAYER_ID, buildFilter());
}

// 4. load or reload the geojson+fill layer
function loadLayer(fname){
  const url = `docs/${fname}`;
  if(map.getSource(SOURCE_ID)){
    map.removeLayer(LAYER_ID);
    map.removeSource(SOURCE_ID);
  }
  map.addSource(SOURCE_ID,{ type:'geojson', data:url });
  map.addLayer({
    id: LAYER_ID,
    type: 'fill',
    source: SOURCE_ID,
    paint: {
      'fill-color': [
        'interpolate',['linear'], ['get','sum_val'],
        0,   '#edf8fb',
        10,  '#b2e2e2',
        50,  '#66c2a4',
        200, '#238b45'
      ],
      'fill-opacity': 0.6
    }
  });

  updateFilter();
}

// 5. popup logic: show either weight or bf stats
map.on('click', LAYER_ID, e => {
  const p = e.features[0].properties;
  const layer = document.getElementById('layerSel').value;
  let title, val;
  if(layer.includes('_weight')){
    title = 'Mortality position count';
    val = p.sum_val;
  } else if(layer.includes('bf_mean')){
    title = 'Mortality est. (mean)';
    val = p.mean_val;
  } else if(layer.includes('bf_low')){
    title = 'Mortality est. (low)';
    val = p.low_val;
  } else if(layer.includes('bf_high')){
    title = 'Mortality est. (high)';
    val = p.high_val;
  }
  new maplibregl.Popup()
    .setLngLat(e.lngLat)
    .setHTML(`<b>${title}</b>: ${val}`)
    .addTo(map);
});

// change cursor over hexes
map.on('mouseenter', LAYER_ID, () => map.getCanvas().style.cursor='pointer');
map.on('mouseleave', LAYER_ID, () => map.getCanvas().style.cursor='');

// 6. wire up UI
document.getElementById('loadBtn').onclick = () => {
  loadLayer(document.getElementById('layerSel').value);
};
document.querySelectorAll('details select')
        .forEach(s => s.onchange = updateFilter);

// 7. on map-load, auto‐load the default (r4)
map.on('load', () => {
  document.getElementById('layerSel').value = 'hexgrid_r4_weight.geojson';
  loadLayer('hexgrid_r4_weight.geojson');
});

</script>
</body>
</html>
