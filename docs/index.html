<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>PMTiles Smoke Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import { PMTiles } from "https://cdn.jsdelivr.net/npm/pmtiles@4.3.0/+esm?v=2";
import vectorTileLayer from "https://cdn.jsdelivr.net/npm/leaflet-vector-tile-layer@0.16.1/+esm?v=2";
import { VectorTile } from "https://cdn.jsdelivr.net/npm/@mapbox/vector-tile@1.3.1/+esm?v=2";
import Pbf from "https://cdn.jsdelivr.net/npm/pbf@3.2.1/+esm?v=2";

const map=L.map('map').setView([-24,-45],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

// pmtiles range-loader + fetch interceptor
const cache=new Map();
const abs = rel => new URL(rel, new URL('.', location.href)).toString();
async function getPM(archive){ if(cache.has(archive)) return cache.get(archive); const pm=new PMTiles(abs(archive)); cache.set(archive,pm); return pm; }
const origFetch=window.fetch.bind(window);
window.fetch=async (input, init)=>{
  if(typeof input==='string' && input.startsWith('pmtiles://')){
    const m=input.match(/^pmtiles:\/\/(.+?)\/(\d+)\/(\d+)\/(\d+)\.pbf$/); if(!m) return Promise.reject(new Error('bad pmtiles url'));
    const [_,archive,z,x,y]=m; const pm=await getPM(archive); const t=await pm.getZxy(+z,+x,+y);
    return (t && t.data) ? new Response(t.data) : new Response(null,{status:204});
  }
  return origFetch(input,init);
};

// detect first layer name
async function detectLayerName(pmFile){
  const pm = await getPM(pmFile);
  const md = await pm.getMetadata();
  if(md && md.json){
    const j = (typeof md.json==='string')?JSON.parse(md.json):md.json;
    if(j && j.vector_layers){
      if(Array.isArray(j.vector_layers) && j.vector_layers.length) return j.vector_layers[0].id || 'hexgrid';
      const keys = Object.keys(j.vector_layers); if(keys.length) return keys[0];
    }
  }
  // fallback: peek one tile
  const hdr = await pm.getHeader();
  const z=Math.max(hdr.minZoom, Math.min(hdr.maxZoom, 6));
  const t = await pm.getZxy(z, 32, 32);
  if(t && t.data){ const vt=new VectorTile(new Pbf(t.data)); const names=Object.keys(vt.layers||{}); if(names.length) return names[0]; }
  return 'hexgrid';
}

// CHANGE HERE to any of your files to test
const pmFile='hexgrid_r6_weight.pmtiles';
const layerName = await detectLayerName(pmFile);

// render
const vt = vectorTileLayer(`pmtiles://${pmFile}/{z}/{x}/{y}.pbf`,{
  style:()=>({color:'#3388ff',weight:0.5,fill:true,fillColor:'#3388ff',fillOpacity:0.4}),
  filter:()=>true
});
vt.addTo(map);
</script>
</body>
</html>
