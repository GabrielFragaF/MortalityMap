<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sea Turtle Mortality Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PMTiles UMD build -->
<script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

<!-- VectorGrid -->
<script src="https://unpkg.com/@mapbox/leaflet-vector-grid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

<!-- Simple statistics for Jenks breaks -->
<script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

<style>
:root {
  --bg: #0b1220;
  --panel-bg: #ffffff;
  --accent: #0ea5e9;
  --text: #111827;
  --muted: #6b7280;
  --shadow: 0 4px 20px rgba(0,0,0,.25);
}
html, body { height:100%; margin:0; background:var(--bg); }
#map { position:absolute; inset:0; }

/* Filter Panel */
#panel {
  position:absolute; top:14px; left:14px; z-index:1000;
  background:var(--panel-bg); border-radius:12px; box-shadow:var(--shadow);
  width:320px; max-height:90vh; overflow:auto;
  font-family: system-ui, sans-serif; font-size:14px;
  transition: all 0.3s ease;
}
#panel.collapsed { height:36px; overflow:hidden; }
#panel h1 { font-size:16px; font-weight:700; margin:0; color:var(--text); }
.topbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px; border-bottom:1px solid #ddd;
}
.topbar button {
  background:#f3f4f6; border:1px solid #ddd; border-radius:6px;
  padding:4px 8px; cursor:pointer;
}
.row { padding:8px 12px; }
label { display:block; font-weight:600; margin-bottom:4px; }
select { width:100%; padding:6px; border-radius:6px; border:1px solid #ddd; }

/* Legend */
#legend {
  position:absolute; bottom:18px; left:14px; z-index:1000;
  background:var(--panel-bg); border-radius:10px; padding:10px; box-shadow:var(--shadow);
  font-family:inherit; font-size:13px; border:1px solid #ddd;
}
.swatch {
  display:inline-block; width:22px; height:12px; margin-right:6px;
  border-radius:3px; border:1px solid #999; vertical-align:middle;
}

/* Spinner + toast */
#spinner {
  position:absolute; top:14px; right:14px; z-index:1000; display:none;
  background:var(--panel-bg); padding:8px 10px; border-radius:10px; box-shadow:var(--shadow);
  border:1px solid #ddd; font-size:13px;
}
#toast {
  position:absolute; top:60px; right:14px; z-index:1000; display:none;
  background:#fee2e2; color:#991b1b; padding:8px 10px; border-radius:10px; border:1px solid #fecaca;
  font-size:13px;
}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <div class="topbar">
    <h1>Mortality Map</h1>
    <div>
      <button id="collapseBtn">â€“</button>
      <button id="permalink">ðŸ”—</button>
    </div>
  </div>
  <div class="row">
    <label for="resolution">Resolution</label>
    <select id="resolution">
      <option value="r3">r3</option>
      <option value="r4">r4</option>
      <option value="r5">r5</option>
      <option value="r6" selected>r6</option>
    </select>
  </div>
  <div class="row">
    <label for="counttype">Count Type</label>
    <select id="counttype">
      <option value="weight">Mortality position</option>
      <option value="new_mortality_est_bf_mean">Mortality estimation (mean)</option>
      <option value="new_mortality_est_bf_low">Mortality estimation (low)</option>
      <option value="new_mortality_est_bf_high">Mortality estimation (high)</option>
    </select>
  </div>
  <div class="row">
    <label>Species</label>
    <select id="speciesFilter" multiple size="5">
      <option value="Caretta caretta">Caretta caretta</option>
      <option value="Chelonia mydas">Chelonia mydas</option>
      <option value="Dermochelys coriacea">Dermochelys coriacea</option>
      <option value="Eretmochelys imbricata">Eretmochelys imbricata</option>
      <option value="Lepidochelys olivacea">Lepidochelys olivacea</option>
    </select>
  </div>
  <div class="row">
    <label>Stage</label>
    <select id="stageFilter" multiple size="4">
      <option value="Adulto">Adulto</option>
      <option value="Juvenil">Juvenil</option>
      <option value="Filhote">Filhote</option>
      <option value="Indeterminado">Indeterminado</option>
    </select>
  </div>
  <div class="row">
    <button id="resetBtn">Reset</button>
  </div>
</div>

<div id="legend"></div>
<div id="spinner">Loadingâ€¦</div>
<div id="toast"></div>

<script>
// Aliases from UMD
const { PMTiles, MemorySource } = pmtiles;

// Map init
const map = L.map('map', { zoomSnap: 0.25 }).setView([-24, -45], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// In-memory PMTiles loader with absolute URL
const memPM = new Map();
async function getPM(archive) {
  if (memPM.has(archive)) return memPM.get(archive);
  const BASE = new URL('.', location.href);
  const url  = new URL(archive, BASE).toString();
  console.log('Fetching PMTiles archive:', url);
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Failed to load ${url} (HTTP ${resp.status})`);
  const buf = new Uint8Array(await resp.arrayBuffer());
  const pm = new PMTiles(new MemorySource(buf));
  memPM.set(archive, pm);
  return pm;
}

// Override fetch for pmtiles://
const origFetch = window.fetch.bind(window);
window.fetch = async (input, init) => {
  if (typeof input === 'string' && input.startsWith('pmtiles://')) {
    const m = input.match(/^pmtiles:\/\/(.+?)\/(\d+)\/(\d+)\/(\d+)\.pbf$/);
    if (!m) return Promise.reject(new Error('Bad pmtiles URL'));
    const archive = m[1], z = +m[2], x = +m[3], y = +m[4];
    try {
      const pm = await getPM(archive);
      const t  = await pm.getZxy(z, x, y);
      return (t && t.data) ? new Response(t.data) : new Response(null, { status: 204 });
    } catch (e) {
      console.error('Tile fetch failed', archive, z, x, y, e);
      return new Response(null, { status: 204 });
    }
  }
  return origFetch(input, init);
};

// Color ramps
const ramps = {
  'Caretta caretta': ['#feedde','#fdbe85','#fd8d3c','#e6550d','#a63603'],
  'Chelonia mydas': ['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'],
  'Dermochelys coriacea': ['#eff3ff','#bdd7e7','#6baed6','#3182bd','#08519c'],
  'Eretmochelys imbricata': ['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'],
  'Lepidochelys olivacea': ['#f7fcf5','#d9f0d3','#a6dba0','#5aae61','#1b7837'],
  'multi': ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15']
};

let currentLayer=null, layerName=null, breaks=[0,1,2,3,4,5];

function getSelected(id) {
  const node=document.getElementById(id);
  return Array.from(node.selectedOptions).map(o=>o.value);
}

function updateLegend(ramp){
  const legend=document.getElementById('legend');
  legend.innerHTML='';
  for (let i=0;i<breaks.length-1;i++){
    legend.innerHTML += `<div><span class="swatch" style="background:${ramp[i]}"></span>${breaks[i]} â€“ ${breaks[i+1]}</div>`;
  }
}

async function loadLayer(){
  const res = document.getElementById('resolution').value;
  const ct = document.getElementById('counttype').value;
  const pmFile = `hexgrid_${res}_${ct}.pmtiles`;
  layerName = 'hexgrid'; // fallback name for your data

  if (currentLayer) map.removeLayer(currentLayer);

  let ramp = ramps['multi'];
  const sp = getSelected('speciesFilter');
  if (sp.length===1 && ramps[sp[0]]) ramp = ramps[sp[0]];

  updateLegend(ramp);

  currentLayer = L.vectorGrid.protobuf(`pmtiles://${pmFile}/{z}/{x}/{y}.pbf`, {
    vectorTileLayerStyles: {
      [layerName]: props => {
        const val = props.sum_val;
        let idx = breaks.findIndex(b => val <= b) - 1;
        if (idx<0) idx = breaks.length-2;
        return {
          fill:true, fillColor:ramp[idx], fillOpacity:0.6,
          stroke:true, color:ramp[idx], weight:0.5
        };
      }
    },
    interactive:true,
    getFeatureId: f => f.properties.h3_index
  })
  .on('mouseover', e=>{
    const p=e.layer.properties;
    const html = `<b>${p.species||''}</b><br/>Value: ${p.sum_val}`;
    L.popup({offset:[0,-8],autoPan:false}).setLatLng(e.latlng).setContent(html).openOn(map);
  })
  .on('mouseout', ()=>map.closePopup())
  .addTo(map);
}

document.getElementById('resolution').addEventListener('change',loadLayer);
document.getElementById('counttype').addEventListener('change',loadLayer);
document.getElementById('speciesFilter').addEventListener('change',loadLayer);
document.getElementById('resetBtn').addEventListener('click',()=>{
  document.querySelectorAll('select').forEach(s=>s.selectedIndex=-1);
  loadLayer();
});
document.getElementById('collapseBtn').addEventListener('click',()=>{
  document.getElementById('panel').classList.toggle('collapsed');
});

loadLayer();
</script>
</body>
</html>
