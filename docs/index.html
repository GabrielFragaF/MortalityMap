<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sea Turtle Mortality Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PMTiles (UMD; CSP-safe) -->
<script src="https://unpkg.com/pmtiles@4.3.0/dist/pmtiles.js"></script>

<!-- VectorGrid (UMD; CSP-safe) -->
<script src="https://unpkg.com/@mapbox/leaflet-vector-grid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

<!-- VectorTile + Pbf for reading tiles (UMD; CSP-safe) -->
<script src="https://unpkg.com/pbf@3.2.1/dist/pbf.js"></script>
<script src="https://unpkg.com/@mapbox/vector-tile@1.3.1/dist/vector-tile.js"></script>

<!-- Simple statistics (Jenks) -->
<script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

<style>
:root{--bg:#0b1220;--panel:#fff;--panel-weak:#f8fafc;--text:#0f172a;--muted:#64748b;--ring:#93c5fd;--shadow:0 10px 30px rgba(2,6,23,.25)}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
#map{position:absolute;inset:0}

/* Panel */
#panel{position:absolute;top:14px;left:14px;z-index:1000;width:360px;max-height:90vh;overflow:auto;background:var(--panel);border-radius:16px;box-shadow:var(--shadow);border:1px solid #e2e8f0}
#panel.collapsed{height:46px;overflow:hidden}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e2e8f0;background:var(--panel-weak)}
.topbar h1{font-size:16px;margin:0;font-weight:800;letter-spacing:.2px}
.iconbtn{background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600}
.iconbtn:hover{filter:brightness(0.98)}
.section{padding:10px 14px}
.row{margin-bottom:10px}
label{display:block;font-weight:700;margin:6px 0;font-size:13px}
select{width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
details{border:1px solid #e2e8f0;border-radius:12px;background:#fff}
details+details{margin-top:10px}
summary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:800;background:#f8fafc;border-radius:12px}
summary::-webkit-details-marker{display:none}
details .content{padding:10px 12px}
.controls-footer{display:flex;gap:10px;justify-content:space-between;margin-top:6px}
#resetBtn,#applyBtn{flex:1;background:#0ea5e9;border:none;color:#fff;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
#resetBtn{background:#e11d48}
.help{font-size:12px;color:var(--muted);margin-top:4px}

/* Legend bottom-right */
#legend{position:absolute;bottom:18px;right:14px;z-index:1000;background:#fff;border-radius:12px;box-shadow:var(--shadow);border:1px solid #e2e8f0;padding:10px 12px;font-size:13px;min-width:220px}
.leghdr{font-weight:800;margin-bottom:8px}.legend-row{display:flex;align-items:center;margin:4px 0}
.swatch{width:26px;height:12px;border-radius:3px;border:1px solid #94a3b8;margin-right:8px}

/* Spinner + toast */
#spinner{position:absolute;top:14px;right:14px;z-index:1000;display:none;background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;box-shadow:var(--shadow);font-size:13px}
#toast{position:absolute;top:60px;right:14px;z-index:1000;display:none;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;box-shadow:var(--shadow);font-size:13px;max-width:320px}

.leaflet-popup-content{margin:8px 12px}.kv{display:flex;justify-content:space-between;gap:10px}.kv b{color:#0f172a}small.muted{color:#64748b}
</style>
</head>
<body>
<div id="map"></div>

<!-- Filter Panel -->
<div id="panel">
  <div class="topbar">
    <h1>Sea Turtle Mortality</h1>
    <div style="display:flex;gap:8px">
      <button id="permalink" class="iconbtn" title="Copy link">ðŸ”— Share</button>
      <button id="collapseBtn" class="iconbtn" title="Collapse">â€“</button>
    </div>
  </div>

  <div class="section">
    <div class="row">
      <label for="resolution">Resolution (H3)</label>
      <select id="resolution">
        <option value="r3" selected>r3</option>
        <option value="r4">r4</option>
        <option value="r5">r5</option>
        <option value="r6">r6</option>
      </select>
      <div class="help">Start at r3 for speed; switch to r6 for detail.</div>
    </div>

    <div class="row">
      <label for="counttype">Count Type</label>
      <select id="counttype">
        <option value="weight" selected>Mortality position (weight)</option>
        <option value="new_weight">Mortality position (new_weight)</option>
        <option value="new_mortality_est_bf_mean">Mortality estimation (mean)</option>
        <option value="new_mortality_est_bf_low">Mortality estimation (low)</option>
        <option value="new_mortality_est_bf_high">Mortality estimation (high)</option>
      </select>
    </div>

    <details open>
      <summary>Species & Stage</summary>
      <div class="content">
        <div class="row">
          <label for="speciesFilter">Species</label>
          <select id="speciesFilter" multiple size="6">
            <option value="__ALL__" selected>(All)</option>
            <option value="Caretta caretta">Caretta caretta</option>
            <option value="Chelonia mydas">Chelonia mydas</option>
            <option value="Dermochelys coriacea">Dermochelys coriacea</option>
            <option value="Eretmochelys imbricata">Eretmochelys imbricata</option>
            <option value="Lepidochelys olivacea">Lepidochelys olivacea</option>
          </select>
        </div>
        <div class="row">
          <label for="stageFilter">Development stage</label>
          <select id="stageFilter" multiple size="7">
            <option value="__ALL__" selected>(All)</option>
            <option value="Adulto">Adulto</option><option value="Juvenil">Juvenil</option>
            <option value="Filhote">Filhote</option><option value="Indeterminado">Indeterminado</option>
            <option value="Adult">Adult</option><option value="Juvenile">Juvenile</option>
          </select>
        </div>
        <div class="row">
          <label for="sexFilter">Sex</label>
          <select id="sexFilter" multiple size="7">
            <option value="__ALL__" selected>(All)</option>
            <option value="FÃªmea">FÃªmea</option><option value="Macho">Macho</option><option value="Indefinido">Indefinido</option>
            <option value="Female">Female</option><option value="Male">Male</option><option value="Unknown">Unknown</option>
          </select>
        </div>
      </div>
    </details>

    <details>
      <summary>Human interactions</summary>
      <div class="content">
        <div class="row"><label for="FishingFilter">Fishing</label>
          <select id="FishingFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="Marine_DebrisFilter">Marine Debris</label>
          <select id="Marine_DebrisFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="AgressionFilter">Aggression</label>
          <select id="AgressionFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="Boat_collisionFilter">Boat collision</label>
          <select id="Boat_collisionFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="DredgingFilter">Dredging</label>
          <select id="DredgingFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="OilFilter">Oil</label>
          <select id="OilFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
        <div class="row"><label for="PetrolFilter">Petrol</label>
          <select id="PetrolFilter" multiple size="5">
            <option value="__ALL__" selected>(All)</option><option>Yes</option><option>No</option><option>Sim</option><option>NÃ£o</option>
          </select>
        </div>
      </div>
    </details>

    <details>
      <summary>Environment & time</summary>
      <div class="content">
        <div class="row">
          <label for="decompFilter">Decomposition code</label>
          <select id="decompFilter" multiple size="11">
            <option value="__ALL__" selected>(All)</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>1.0</option><option>2.0</option><option>3.0</option><option>4.0</option><option>5.0</option>
          </select>
        </div>
        <div class="row">
          <label for="seasonFilter">Season</label>
          <select id="seasonFilter" multiple size="9">
            <option value="__ALL__" selected>(All)</option>
            <option>Autumn</option><option>Spring</option><option>Summer</option><option>Winter</option>
            <option>Outono</option><option>Primavera</option><option>VerÃ£o</option><option>Inverno</option>
          </select>
        </div>
        <div class="row">
          <label for="yearFilter">Year</label>
          <select id="yearFilter" multiple size="13">
            <option value="__ALL__" selected>(All)</option>
            <option>2010</option><option>2011</option><option>2012</option><option>2013</option><option>2014</option>
            <option>2015</option><option>2016</option><option>2017</option><option>2018</option><option>2019</option>
            <option>2020</option><option>2021</option><option>2022</option><option>2023</option><option>2024</option><option>2025</option>
            <option>2015.0</option><option>2016.0</option><option>2017.0</option><option>2018.0</option><option>2019.0</option>
            <option>2020.0</option><option>2021.0</option><option>2022.0</option><option>2023.0</option><option>2024.0</option><option>2025.0</option>
          </select>
        </div>
        <div class="row">
          <label for="monthFilter">Month</label>
          <select id="monthFilter" multiple size="13">
            <option value="__ALL__" selected>(All)</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
      </div>
    </details>

    <div class="controls-footer">
      <button id="resetBtn">Reset</button>
      <button id="applyBtn">Apply</button>
    </div>
  </div>
</div>

<div id="legend"></div>
<div id="spinner">Loadingâ€¦</div>
<div id="toast"></div>

<script>
/* ===== Map ===== */
const map = L.map('map',{zoomSnap:0.25,worldCopyJump:true}).setView([-24,-45],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

/* ===== UI helpers ===== */
const $ = id => document.getElementById(id);
const spinner=$('spinner'), toast=$('toast');
const showSpinner = (m='Loadingâ€¦') => { spinner.textContent=m; spinner.style.display='block'; };
const hideSpinner = () => { spinner.style.display='none'; };
const showToast=(m,ms=3500)=>{ toast.textContent=m; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); };
$('collapseBtn').addEventListener('click',()=>$('panel').classList.toggle('collapsed'));

function enforceAllOption(e){
  const sel=e.target; if(!sel.multiple) return;
  const all = Array.from(sel.options).find(o=>o.value==='__ALL__');
  const chosen = Array.from(sel.selectedOptions).map(o=>o.value);
  if(chosen.length===0){ all.selected=true; }
  else if(chosen.includes('__ALL__') && chosen.length>1){
    Array.from(sel.options).forEach(o=>o.selected=false); all.selected=true;
  }else if(!chosen.includes('__ALL__') && all.selected){ all.selected=false; }
}
document.querySelectorAll('#panel select[multiple]').forEach(s=>s.addEventListener('change',enforceAllOption));

const getMulti = id => {
  const vals = Array.from($(id).selectedOptions||[]).map(o=>o.value);
  return (vals.length===0 || vals.includes('__ALL__')) ? [] : vals;
};
const clearAllSelects = ()=>{
  document.querySelectorAll('#panel select').forEach(s=>{
    if(s.multiple){
      Array.from(s.options).forEach(o=>o.selected=false);
      const all = Array.from(s.options).find(o=>o.value==='__ALL__'); if(all) all.selected=true;
    }else s.selectedIndex=0;
  });
};
const nf=(v)=>{ if(v===0) return '0'; const abs=Math.abs(v); const digits=abs<1?4:abs<10?3:2; return new Intl.NumberFormat(undefined,{maximumFractionDigits:digits}).format(v); };

/* ===== Color ramps ===== */
const ramps={
  'Caretta caretta':['#feedde','#fdbe85','#fd8d3c','#e6550d','#a63603'],
  'Chelonia mydas':['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'],
  'Dermochelys coriacea':['#eff3ff','#bdd7e7','#6baed6','#3182bd','#08519c'],
  'Eretmochelys imbricata':['#f2f0f7','#cbc9e2','#9e9ac8','#756bb1','#54278f'],
  'Lepidochelys olivacea':['#f7fcf5','#d9f0d3','#a6dba0','#5aae61','#1b7837'],
  'multi':['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15']
};
let jenksBreaks=[0,1,2,3,4,5], activeRamp=ramps['multi'];
function updateLegend(){
  const el=$('legend');
  const spSel=getMulti('speciesFilter');
  const name=(spSel.length===1)?spSel[0]:(spSel.length>1?'Multiple species':'All species');
  el.innerHTML=`<div class="leghdr">${name}</div>`;
  for(let i=0;i<activeRamp.length;i++){
    const a=jenksBreaks[i], b=jenksBreaks[i+1]; if(b==null) break;
    el.insertAdjacentHTML('beforeend',`<div class="legend-row"><span class="swatch" style="background:${activeRamp[i]}"></span><span>${nf(a)} â€“ ${nf(b)}</span></div>`);
  }
}
const currentRamp=()=>{ const sp=getMulti('speciesFilter'); return (sp.length===1 && ramps[sp[0]]) ? ramps[sp[0]] : ramps['multi']; };

/* ===== Filters ===== */
const norm=v=>(v==null?'':String(v)).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const asIntString=v=>{ const n=parseInt(v,10); return Number.isFinite(n)?String(n):String(v); };
function makePredicate(){
  const sel={
    species:new Set(getMulti('speciesFilter').map(norm)),
    development_stage:new Set(getMulti('stageFilter').map(norm)),
    sex:new Set(getMulti('sexFilter').map(norm)),
    Fishing:new Set(getMulti('FishingFilter').map(norm)),
    Marine_Debris:new Set(getMulti('Marine_DebrisFilter').map(norm)),
    Agression:new Set(getMulti('AgressionFilter').map(norm)),
    Boat_collision:new Set(getMulti('Boat_collisionFilter').map(norm)),
    Dredging:new Set(getMulti('DredgingFilter').map(norm)),
    Oil:new Set(getMulti('OilFilter').map(norm)),
    Petrol:new Set(getMulti('PetrolFilter').map(norm)),
    decomposition_code:new Set(getMulti('decompFilter').map(norm)),
    season:new Set(getMulti('seasonFilter').map(norm)),
    year:new Set(getMulti('yearFilter').map(norm)),
    month:new Set(getMulti('monthFilter').map(norm))
  };
  const test=(k,v)=>{ const set=sel[k]; if(!set.size) return true; const pv=norm(v);
    if(set.has(pv)) return true;
    if(k==='year'||k==='month'||k==='decomposition_code'){ return set.has(asIntString(v))||set.has(asIntString(pv)); }
    return false;
  };
  return p=>(
    test('species',p.species)&&test('development_stage',p.development_stage)&&test('sex',p.sex)&&
    test('Fishing',p.Fishing)&&test('Marine_Debris',p.Marine_Debris)&&test('Agression',p.Agression)&&
    test('Boat_collision',p.Boat_collision)&&test('Dredging',p.Dredging)&&test('Oil',p.Oil)&&
    test('Petrol',p.Petrol)&&test('decomposition_code',p.decomposition_code)&&
    test('season',p.season)&&test('year',p.year)&&test('month',p.month)
  );
}

/* ===== PMTiles fetch shim (pmtiles://...) ===== */
const origFetch = window.fetch.bind(window);
async function getPM(archive){
  // pmtiles UMD exposes pmtiles.PMTiles
  const u = new URL(archive, new URL('.', location.href)).toString();
  return new pmtiles.PMTiles(u);
}
window.fetch = async (input, init) => {
  if (typeof input === 'string' && input.startsWith('pmtiles://')) {
    const m = input.match(/^pmtiles:\/\/(.+?)\/(\d+)\/(\d+)\/(\d+)\.pbf$/);
    if (!m) return Promise.reject(new Error('Bad pmtiles URL'));
    const [_, archive, z, x, y] = m;
    try{
      const pm = await getPM(archive);
      const t  = await pm.getZxy(+z,+x,+y);
      return (t && t.data) ? new Response(t.data) : new Response(null,{status:204});
    }catch(e){
      console.error('Tile fetch failed for', archive, z, x, y, e);
      return new Response(null,{status:204});
    }
  }
  return origFetch(input, init);
};

/* ===== Helpers for tile ranges ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function lon2tile(lon,z){return Math.floor((lon+180)/360*Math.pow(2,z));}
function lat2tile(lat,z){const r=lat*Math.PI/180;return Math.floor((1-Math.log(Math.tan(r)+1/Math.cos(r))/Math.PI)/2*Math.pow(2,z));}
function tileRangeForBounds(b,z){
  const nw=b.getNorthWest(), se=b.getSouthEast();
  let minX=lon2tile(nw.lng,z), maxX=lon2tile(se.lng,z);
  let minY=lat2tile(nw.lat,z), maxY=lat2tile(se.lat,z);
  if(maxX<minX)[minX,maxX]=[maxX,minX]; if(maxY<minY)[minY,maxY]=[maxY,minY];
  const n=Math.pow(2,z); minY=Math.max(0,Math.min(n-1,minY)); maxY=Math.max(0,Math.min(n-1,maxY));
  return {minX,maxX,minY,maxY};
}
const wrapX=(x,z)=>{const n=Math.pow(2,z);return((x%n)+n)%n;};

/* ===== File resolver ===== */
const fileFor=(res,ct)=>`hexgrid_${res}_${ct}.pmtiles`;

/* ===== State ===== */
let vtLayer=null, currentPMFile='', layerName='', header=null;
let aggByHex = new Map();              // h3_index -> {sum, count}
let metricField = 'sum_val';           // runtime discovery

/* ===== Detect the layer name in the PMTiles ===== */
async function detectLayerName(pmFile){
  try{
    const pm = await getPM(pmFile);
    header = await pm.getHeader();
    const md = await pm.getMetadata();
    if (md && md.json){
      const j = (typeof md.json==='string') ? JSON.parse(md.json) : md.json;
      if (j && j.vector_layers){
        if (Array.isArray(j.vector_layers) && j.vector_layers.length) return j.vector_layers[0].id || 'hexgrid';
        const keys = Object.keys(j.vector_layers); if(keys.length) return keys[0];
      }
    }
    // fallback: read a visible tile and list its layer keys
    const z = clamp(Math.floor(map.getZoom()), header.minZoom, header.maxZoom);
    const {minX,maxX,minY,maxY}=tileRangeForBounds(map.getBounds(), z);
    for(let x=minX;x<=maxX;x++){
      for(let y=minY;y<=maxY;y++){
        const r = await (await getPM(pmFile)).getZxy(z, wrapX(x,z), y);
        if(!r || !r.data) continue;
        const vt = new VectorTile(new Pbf(r.data));
        const names = Object.keys(vt.layers||{}); if(names.length) return names[0];
      }
    }
  }catch(e){ console.warn('Layer detect failed:', e); }
  console.warn('Falling back to "hexgrid"');
  return 'hexgrid';
}

/* ===== Aggregation + breaks ===== */
const JENKS_CLASSES = 5;
const EXACT_MAX = 2000;
const SAMPLE_TARGET = 1200;
const MAX_TILES_STATS = 250;

function reservoirSample(values, k){
  const out=[];
  for(let i=0;i<values.length;i++){
    if(i<k) out[i]=values[i];
    else{
      const j = Math.floor(Math.random()*(i+1));
      if(j<k) out[j]=values[i];
    }
  }
  return out;
}
function prettyBreaks(min, max){
  if (!isFinite(min) || !isFinite(max)) return [0,1,2,3,4,5];
  if (min===max) { const eps = min===0 ? 1 : Math.abs(min)*0.1; min -= eps; max += eps; }
  const step=(max-min)/JENKS_CLASSES, arr=[min];
  for(let i=1;i<=JENKS_CLASSES;i++) arr.push(min+i*step);
  return arr;
}
const fieldCandidatesByCT = {
  weight: ['weight','sum_val'],
  new_weight: ['new_weight','sum_val'],
  new_mortality_est_bf_mean: ['new_mortality_est_bf_mean','sum_val'],
  new_mortality_est_bf_low: ['new_mortality_est_bf_low','sum_val'],
  new_mortality_est_bf_high: ['new_mortality_est_bf_high','sum_val']
};
function discoverMetricField(sampleProps, ct){
  const cands = fieldCandidatesByCT[ct] || ['sum_val'];
  for(const k of cands){ if(k in sampleProps && Number.isFinite(Number(sampleProps[k]))) return k; }
  if('sum_val' in sampleProps) return 'sum_val';
  for(const k of Object.keys(sampleProps)){ if(Number.isFinite(Number(sampleProps[k]))) return k; }
  return 'sum_val';
}

async function aggregateAndCollect(pmFile, layerName, predicate, ct){
  aggByHex.clear();
  const pm = await getPM(pmFile);
  const hdr = header || await pm.getHeader();
  const zView = clamp(Math.floor(map.getZoom()), hdr.minZoom, hdr.maxZoom);
  const {minX,maxX,minY,maxY} = tileRangeForBounds(map.getBounds(), zView);

  const tilesX=maxX-minX+1, tilesY=maxY-minY+1;
  let stride=1;
  if(tilesX*tilesY>MAX_TILES_STATS){
    const factor=Math.ceil(Math.sqrt((tilesX*tilesY)/MAX_TILES_STATS));
    stride=Math.max(1,factor);
  }

  let discovered=false;
  const jobs=[];
  for(let x=minX;x<=maxX;x+=stride){
    for(let y=minY;y<=maxY;y+=stride){
      jobs.push(pm.getZxy(zView, wrapX(x,zView), y).then(resp=>{
        if(!resp || !resp.data) return;
        const vt = new VectorTile(new Pbf(resp.data));
        const lyr = vt.layers[layerName]; if(!lyr) return;
        for(let i=0;i<lyr.length;i++){
          const props = lyr.feature(i).properties||{};
          if(!discovered){ metricField=discoverMetricField(props, ct); discovered=true; }
          if(!predicate(props)) continue;
          const key = props.h3_index ?? props.h3 ?? props.id; if(!key) continue;
          const val = Number(props[metricField]);
          const cnt = Number(props.count);
          const entry = aggByHex.get(key) || {sum:0,count:0};
          if(Number.isFinite(val)) entry.sum += val;
          if(Number.isFinite(cnt)) entry.count += cnt; else entry.count += 1;
          aggByHex.set(key, entry);
        }
      }).catch(()=>{}));
    }
  }
  await Promise.all(jobs);
  return Array.from(aggByHex.values()).map(d=>d.sum).filter(v=>Number.isFinite(v));
}

async function computeBreaksFromAggregates(values){
  const n=values.length;
  if(!n) return [0,1,2,3,4,5];
  if(n<8){ const min=Math.min(...values), max=Math.max(...values); return prettyBreaks(min,max); }
  let edges;
  try{
    const arr = (n<=EXACT_MAX)? values : reservoirSample(values, SAMPLE_TARGET);
    edges = ss.jenks(arr, JENKS_CLASSES);
    const unique = Array.from(new Set(edges.map(x=>+x.toFixed(10))));
    const min=Math.min(...values), max=Math.max(...values);
    if(unique.length < JENKS_CLASSES+1 || !isFinite(min) || !isFinite(max) || min===max){
      const sorted = values.slice().sort((a,b)=>a-b);
      edges = ss.quantileSorted(sorted,[0,0.2,0.4,0.6,0.8,1]);
    }else{
      if(edges[0] > min) edges[0]=min;
      if(edges[edges.length-1] < max) edges.push(max);
      if(edges.length < JENKS_CLASSES+1){
        const sorted = values.slice().sort((a,b)=>a-b);
        edges = ss.quantileSorted(sorted,[0,0.2,0.4,0.6,0.8,1]);
      }
    }
  }catch{
    const sorted = values.slice().sort((a,b)=>a-b);
    edges = ss.quantileSorted(sorted,[0,0.2,0.4,0.6,0.8,1]);
  }
  return edges;
}

/* ===== Styling & popups (use aggregated per-hex values) ===== */
function makeStyle(){
  return (props) => {
    const key = props.h3_index || props.h3 || props.id;
    const agg = key ? aggByHex.get(key) : undefined;
    const v = agg ? agg.sum : undefined;
    if(!Number.isFinite(v)) return {opacity:0, fillOpacity:0, interactive:false};
    let idx=0;
    for(let i=0;i<jenksBreaks.length-1;i++){
      if(v>=jenksBreaks[i] && v<=jenksBreaks[i+1]) { idx=i; break; }
    }
    const color = activeRamp[Math.min(idx,activeRamp.length-1)];
    return {fill:true, fillColor:color, fillOpacity:0.65, color, weight:0.5};
  };
}
function bindHoverPopups(layer){
  layer.on('mouseover', e=>{
    const p = e.layer?.properties || {};
    const key = p.h3_index || p.h3 || p.id;
    const agg = key ? aggByHex.get(key) : undefined;
    const sum = agg ? agg.sum : undefined;
    const cnt = agg ? agg.count : undefined;
    L.popup({autoPan:false,offset:[0,-8]}).setLatLng(e.latlng).setContent(`
      <div style="min-width:240px">
        <div class="kv"><b>Species</b><span>${p.species ?? '(mixed)'}</span></div>
        <div class="kv"><b>Sum (${metricField})</b><span>${Number.isFinite(sum)?nf(sum):'-'}</span></div>
        <div class="kv"><b>Count</b><span>${Number.isFinite(cnt)?nf(cnt):'-'}</span></div>
        <hr/>
        <div class="kv"><b>Stage</b><span>${p.development_stage ?? '-'}</span></div>
        <div class="kv"><b>Sex</b><span>${p.sex ?? '-'}</span></div>
        <div class="kv"><b>Season</b><span>${p.season ?? '-'}</span></div>
        <div class="kv"><b>Year</b><span>${p.year ?? '-'}</span></div>
        <div class="kv"><b>Month</b><span>${p.month ?? '-'}</span></div>
        <hr/>
        <small class="muted">h3: ${key ?? '-'}</small>
      </div>`).openOn(map);
  });
  layer.on('mouseout',()=>map.closePopup());
}

/* ===== Build / Rebuild ===== */
function fileFor(res, ct){ return `hexgrid_${res}_${ct}.pmtiles`; }
let predicate=null;

async function buildLayer(){
  showSpinner('Loading & aggregatingâ€¦');
  const res=$('resolution').value, ct=$('counttype').value;
  const pmFile = fileFor(res, ct);
  currentPMFile=pmFile;

  layerName = await detectLayerName(pmFile);
  predicate = makePredicate();

  const values = await aggregateAndCollect(pmFile, layerName, predicate, ct);
  jenksBreaks = await computeBreaksFromAggregates(values);
  activeRamp = currentRamp();
  updateLegend();

  if(vtLayer){ map.removeLayer(vtLayer); vtLayer=null; }
  vtLayer = L.vectorGrid.protobuf(`pmtiles://${pmFile}/{z}/{x}/{y}.pbf`,{
    rendererFactory: L.canvas.tile, // fast
    vectorTileLayerStyles: { [layerName]: makeStyle() },
    interactive:true,
    getFeatureId: f => f.properties && (f.properties.h3_index || f.properties.h3 || f.properties.id)
  });
  bindHoverPopups(vtLayer);
  vtLayer.addTo(map);
  hideSpinner();
}

/* Debounced recompute on move/zoom or filter apply */
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
const recomputeOnMove = debounce(async ()=>{
  if(!currentPMFile || !layerName) return;
  showSpinner('Updatingâ€¦');
  predicate = makePredicate();
  const ct=$('counttype').value;

  const values = await aggregateAndCollect(currentPMFile, layerName, predicate, ct);
  jenksBreaks = await computeBreaksFromAggregates(values);
  activeRamp = currentRamp();
  updateLegend();

  if(vtLayer){ map.removeLayer(vtLayer); vtLayer=null; }
  vtLayer = L.vectorGrid.protobuf(`pmtiles://${currentPMFile}/{z}/{x}/{y}.pbf`,{
    rendererFactory: L.canvas.tile,
    vectorTileLayerStyles: { [layerName]: makeStyle() },
    interactive:true,
    getFeatureId: f => f.properties && (f.properties.h3_index || f.properties.h3 || f.properties.id)
  });
  bindHoverPopups(vtLayer);
  vtLayer.addTo(map);
  hideSpinner();
},250);

/* ===== Permalink ===== */
function readStateFromHash(){
  const h=new URLSearchParams(location.hash.slice(1));
  if(h.has('z')&&h.has('lat')&&h.has('lng')) map.setView([+h.get('lat'),+h.get('lng')], +h.get('z'));
  if(h.has('res')) $('resolution').value=h.get('res');
  if(h.has('ct')) $('counttype').value=h.get('ct');
  const ids=['speciesFilter','stageFilter','sexFilter','FishingFilter','Marine_DebrisFilter','AgressionFilter','Boat_collisionFilter','DredgingFilter','OilFilter','PetrolFilter','decompFilter','seasonFilter','yearFilter','monthFilter'];
  for(const id of ids){ const val=h.get(id); if(!val) continue; const wanted=new Set(val.split('|')); Array.from($(id).options).forEach(o=>o.selected=wanted.has(o.value)); }
}
function writeStateToHash(){
  const h=new URLSearchParams(), c=map.getCenter();
  h.set('z',map.getZoom().toFixed(2)); h.set('lat',c.lat.toFixed(6)); h.set('lng',c.lng.toFixed(6));
  h.set('res',$('resolution').value); h.set('ct',$('counttype').value);
  const ids=['speciesFilter','stageFilter','sexFilter','FishingFilter','Marine_DebrisFilter','AgressionFilter','Boat_collisionFilter','DredgingFilter','OilFilter','PetrolFilter','decompFilter','seasonFilter','yearFilter','monthFilter'];
  for(const id of ids){ const vals=getMulti(id); if(vals.length) h.set(id, vals.join('|')); }
  location.hash=h.toString();
}
$('permalink').addEventListener('click',async()=>{
  writeStateToHash();
  try{ await navigator.clipboard.writeText(location.href); showToast('Link copied to clipboard!'); }
  catch{ showToast('Link updated in address bar.'); }
});

/* ===== Wiring ===== */
$('resolution').addEventListener('change',()=>buildLayer());
$('counttype').addEventListener('change',()=>buildLayer());
['speciesFilter','stageFilter','sexFilter','FishingFilter','Marine_DebrisFilter','AgressionFilter','Boat_collisionFilter','DredgingFilter','OilFilter','PetrolFilter','decompFilter','seasonFilter','yearFilter','monthFilter']
  .forEach(id=>$(id).addEventListener('change',()=>recomputeOnMove()));
$('applyBtn').addEventListener('click',()=>recomputeOnMove());
$('resetBtn').addEventListener('click',()=>{clearAllSelects();recomputeOnMove();});
map.on('moveend',()=>recomputeOnMove());
map.on('zoomend',()=>recomputeOnMove());

/* ===== Boot ===== */
(function init(){ readStateFromHash(); buildLayer(); })();
</script>
</body>
</html>
