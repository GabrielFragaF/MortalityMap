<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sea-turtle mortality map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.1.2/dist/pmtiles.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #panel {
      position:absolute; top:10px; left:10px; z-index:10;
      background:white; padding:10px; border-radius:5px;
      font-family:sans-serif; font-size:14px;
      box-shadow:0 1px 8px rgba(0,0,0,0.20);
      max-height:96%; overflow:auto; min-width:230px;
    }
    #panel label { margin:7px 0 2px 0; font-weight:bold; display:block; }
    #panel select { width:100%; }
    #panel button { margin:12px 0 5px 0; width:100%; font-weight:bold; padding:7px 0; }
    #legend {
      position:absolute; bottom:30px; left:10px; z-index:10;
      background:white; padding:7px 12px; border-radius:4px;
      font-family:sans-serif; font-size:13px;
      box-shadow:0 1px 4px rgba(0,0,0,0.2);
    }
    .swatch { display:inline-block; width:20px; height:12px; margin-right:4px; border:1px solid #666; }
    details { margin:5px 0; }
    summary { cursor:pointer; font-weight:normal; padding:2px 0;}
    .filter-multiselect { width:100%; min-height:25px; margin-top:2px; }
    .filter-multiselect option { padding:3px 0; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <label for="resolution">Resolution (hex-size):</label>
  <select id="resolution">
    <option value="r3">r3 (coarse)</option>
    <option value="r4" selected>r4</option>
    <option value="r5">r5</option>
    <option value="r6">r6 (fine)</option>
  </select>

  <label for="counttype">Count Type:</label>
  <select id="counttype">
    <option value="weight">Mortality position</option>
    <option value="new_mortality_est_bf_mean">Mortality estimation (mean)</option>
    <option value="new_mortality_est_bf_low">Mortality estimation (low)</option>
    <option value="new_mortality_est_bf_high">Mortality estimation (high)</option>
  </select>

  <details>
    <summary>Species</summary>
    <select id="speciesFilter" multiple class="filter-multiselect" size="6">
      <option value="Caretta caretta">Caretta caretta</option>
      <option value="Chelonia mydas">Chelonia mydas</option>
      <option value="Dermochelys coriacea">Dermochelys coriacea</option>
      <option value="Eretmochelys imbricata">Eretmochelys imbricata</option>
      <option value="Lepidochelys olivacea">Lepidochelys olivacea</option>
    </select>
  </details>

  <details>
    <summary>Stage</summary>
    <select id="stageFilter" multiple class="filter-multiselect" size="5">
      <option value="Adulto">Adulto</option>
      <option value="Juvenil">Juvenil</option>
      <option value="Filhote">Filhote</option>
      <option value="Indeterminado">Indeterminado</option>
    </select>
  </details>

  <details>
    <summary>Sex</summary>
    <select id="sexFilter" multiple class="filter-multiselect" size="4">
      <option value="Fêmea">Fêmea</option>
      <option value="Macho">Macho</option>
      <option value="Indefinido">Indefinido</option>
    </select>
  </details>

  <details>
    <summary>Fishing</summary>
    <select id="FishingFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Marine Debris</summary>
    <select id="Marine_DebrisFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Agression</summary>
    <select id="AgressionFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Boat Collision</summary>
    <select id="Boat_collisionFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Dredging</summary>
    <select id="DredgingFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Oil</summary>
    <select id="OilFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Petrol</summary>
    <select id="PetrolFilter" multiple class="filter-multiselect" size="3">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
  </details>

  <details>
    <summary>Decomposition</summary>
    <select id="decompFilter" multiple class="filter-multiselect" size="6">
      <option value="1.0">1</option>
      <option value="2.0">2</option>
      <option value="3.0">3</option>
      <option value="4.0">4</option>
      <option value="5.0">5</option>
    </select>
  </details>

  <details>
    <summary>Season</summary>
    <select id="seasonFilter" multiple class="filter-multiselect" size="5">
      <option value="Spring">Spring</option>
      <option value="Summer">Summer</option>
      <option value="Autumn">Autumn</option>
      <option value="Winter">Winter</option>
    </select>
  </details>

  <details>
    <summary>Year</summary>
    <select id="yearFilter" multiple class="filter-multiselect" size="11">
      <option value="2015.0">2015</option>
      <option value="2016.0">2016</option>
      <option value="2017.0">2017</option>
      <option value="2018.0">2018</option>
      <option value="2019.0">2019</option>
      <option value="2020.0">2020</option>
      <option value="2021.0">2021</option>
      <option value="2022.0">2022</option>
      <option value="2023.0">2023</option>
      <option value="2024.0">2024</option>
    </select>
  </details>

  <details>
    <summary>Month</summary>
    <select id="monthFilter" multiple class="filter-multiselect" size="13">
      <option value="1.0">January</option>
      <option value="2.0">February</option>
      <option value="3.0">March</option>
      <option value="4.0">April</option>
      <option value="5.0">May</option>
      <option value="6.0">June</option>
      <option value="7.0">July</option>
      <option value="8.0">August</option>
      <option value="9.0">September</option>
      <option value="10.0">October</option>
      <option value="11.0">November</option>
      <option value="12.0">December</option>
    </select>
  </details>

  <button id="loadBtn">Load Layer</button>
</div>
<div id="legend"></div>
<script>
// Register PMTiles protocol
maplibregl.addProtocol("pmtiles", new pmtiles.Protocol());

// Set up MapLibre base map
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      osm: {
        type: 'raster',
        tiles: [
          'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
        ],
        tileSize: 256
      }
    },
    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
  },
  center: [-45, -24],
  zoom: 5
});

// Color ramps by species
const ramps = {
  all: ['#edf8fb','#b2e2e2','#66c2a4','#238b45','#00441b'],
  'Caretta caretta': ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'],
  'Chelonia mydas':   ['#f7fcf5','#c7e9c0','#74c476','#238b45','#00441b'],
  'Dermochelys coriacea': ['#f7fbff','#c6dbef','#6baed6','#2171b5','#08306b'],
  'Eretmochelys imbricata':['#fff7fb','#ece2f0','#a6bddb','#8771a8','#4d004b'],
  'Lepidochelys olivacea':['#fff7ec','#fee8c8','#fdbb84','#e34a33','#b30000']
};

// Build MapLibre filter from selected dropdowns
function buildFilter() {
  const f = ['all'];
  const props = [
    'species','development_stage','sex','Fishing','Marine_Debris',
    'Agression','Boat_collision','Dredging','Oil','Petrol',
    'decomposition_code','season','year','month'
  ];
  props.forEach(prop => {
    const sel = document.getElementById(prop+'Filter');
    if (!sel) return;
    const vals = Array.from(sel.selectedOptions).map(o=>o.value);
    if(vals.length) f.push(['in',['get',prop],['literal',vals]]);
  });
  return f;
}

// Legend is static (adjust as needed)
function updateLegend(ramp){
  const L = document.getElementById('legend');
  L.innerHTML = '';
  [0, 10, 50, 200, 500].forEach((v,i)=>{
    const sw = document.createElement('span');
    sw.className='swatch'; sw.style.background = ramp[i] || '#fff';
    L.appendChild(sw);
    L.appendChild(document.createTextNode(v + (i < ramp.length-1 ? ' - ' : '+ ')));
  });
}

function getPopupLabel(counttype, props) {
  let val = props.sum_val;
  let label = "Mortality";
  if(counttype === "weight") {
    label = "Mortality position";
  } else if(counttype === "new_mortality_est_bf_mean") {
    label = "Mortality est. (mean)";
  } else if(counttype === "new_mortality_est_bf_low") {
    label = "Mortality est. (low)";
  } else if(counttype === "new_mortality_est_bf_high") {
    label = "Mortality est. (high)";
  }
  return `<b>${label}</b>: ${val}`;
}

let popup = new maplibregl.Popup({ closeButton:false, closeOnClick:false });

function loadLayer(){
  const res = document.getElementById('resolution').value;
  const counttype = document.getElementById('counttype').value;
  const spSel = Array.from(document.getElementById('speciesFilter').selectedOptions)
    .map(o=>o.value);
  const species = spSel.length ? spSel[0] : 'all';
  const ramp = ramps[species] || ramps.all;
  const pmtilesUrl = `pmtiles://hexgrid_${res}_${counttype}.pmtiles`;
  const sourceLayer = `hexgrid_${res}_${counttype}`;

  // Remove previous
  if(map.getLayer('mort-fill')) map.removeLayer('mort-fill');
  if(map.getSource('mort')) map.removeSource('mort');

  map.addSource('mort', {
    type: 'vector',
    url: pmtilesUrl
  });

  map.addLayer({
    id: 'mort-fill',
    type: 'fill',
    source: 'mort',
    'source-layer': sourceLayer,
    paint: {
      'fill-color': [
        'interpolate', ['linear'], ['get', 'sum_val'],
        0, ramp[0], 10, ramp[1], 50, ramp[2], 200, ramp[3]
      ],
      'fill-opacity': 0.6
    },
    filter: buildFilter()
  });

  // Remove previous popup event if any
  map.off('mousemove', onMouseMove);
  map.on('mousemove','mort-fill', onMouseMove);
  map.on('mouseleave','mort-fill', ()=>popup.remove());

  updateLegend(ramp);
}

function onMouseMove(e){
  const p = e.lngLat;
  const pr = e.features[0].properties;
  const counttype = document.getElementById('counttype').value;
  popup.setLngLat(p)
    .setHTML(getPopupLabel(counttype, pr))
    .addTo(map);
}

document.getElementById('loadBtn').onclick = loadLayer;
</script>
</body>
</html>
